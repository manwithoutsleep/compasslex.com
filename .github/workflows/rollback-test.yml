name: Rollback Test Environment

on:
  workflow_dispatch:
    inputs:
      confirm_rollback:
        description: 'Type "ROLLBACK" to confirm you want to restore from backup'
        required: true
        type: string

jobs:
  rollback-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Validate rollback confirmation
      run: |
        if [ "${{ github.event.inputs.confirm_rollback }}" != "ROLLBACK" ]; then
          echo "âŒ Rollback cancelled. You must type 'ROLLBACK' to confirm."
          exit 1
        fi
        echo "âœ… Rollback confirmed. Proceeding with restoration."
        
    - name: Rollback test environment
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          # Check if backup exists
          if [ ! -d "public_html/test.compasslex.com_backup" ]; then
            echo "âŒ No backup found at public_html/test.compasslex.com_backup"
            echo "Cannot perform rollback without a backup."
            exit 1
          fi
          
          echo "ğŸ“¦ Backup found. Starting rollback process..."
          
          # Create a backup of current state before rollback
          if [ -d "public_html/test.compasslex.com_pre_rollback" ]; then
            rm -rf public_html/test.compasslex.com_pre_rollback
          fi
          if [ -d "public_html/test.compasslex.com" ]; then
            cp -r public_html/test.compasslex.com public_html/test.compasslex.com_pre_rollback
            echo "ğŸ’¾ Current state backed up to test.compasslex.com_pre_rollback"
          fi
          
          # Remove current files
          rm -rf public_html/test.compasslex.com/*
          
          # Restore from backup
          cp -r public_html/test.compasslex.com_backup/* public_html/test.compasslex.com/
          
          echo "âœ… Rollback completed successfully!"
          echo "ğŸ”„ Test environment restored from previous backup"
          echo "ğŸ’¡ Current deployment backed up to test.compasslex.com_pre_rollback"
          
    - name: Rollback summary
      run: |
        echo "ğŸ‰ Test environment rollback completed!"
        echo ""
        echo "ğŸ“ What happened:"
        echo "  â€¢ test.compasslex.com restored from backup"
        echo "  â€¢ Previous state saved to test.compasslex.com_pre_rollback"
        echo ""
        echo "ğŸŒ Your test site should now be accessible at test.compasslex.com"